<!-- b38914c1-b07d-47f7-83e2-c0cd1e74e61a f9bd29ab-693d-438f-b3a7-00d4993a110a -->
# План исправления прав доступа в скриптах

## Проблема

На корпоративном ноутбуке могут отсутствовать права на системные директории (`/tmp/`, `/etc/`, `/opt/`). Текущие скрипты используют эти директории, что может привести к ошибкам при тестировании.

## Найденные проблемы

### 1. Скрипт `collect_diagnostics.sh`

- Использует `/tmp/` для временных файлов и архива
- Проверяет `/etc/ssl/corp-ca.pem` без fallback
- Ищет output в `/tmp/digest-out` и `/opt/digest/`

### 2. Скрипт `test_run.sh`

- По умолчанию: `OUT_DIR=/tmp/digest-out`
- По умолчанию: `STATE_DIR=/tmp/digest-state`

### 3. Скрипт `print_env.sh`

- Проверяет `/etc/ssl/corp-ca.pem` без обработки ошибок
- Проверяет `/opt/digest/out` и `/opt/digest/.state`

### 4. Другие скрипты

- `run-local.sh` - использует `/tmp/`
- `rotate_state.sh` - использует `/opt/digest/`
- `deploy.sh` - документирует `/opt/digest/` и `/etc/ssl/`

## Решение

Изменить все скрипты для использования домашней директории пользователя с возможностью переопределения через переменные окружения.

## Изменения по файлам

### 1. `collect_diagnostics.sh`

**Изменить:**

```bash
# Было:
TEMP_DIR="/tmp/${ARCHIVE_NAME}"
ARCHIVE_PATH="/tmp/${ARCHIVE_NAME}.tar.gz"
OUTPUT_DIRS=("./out" "/tmp/digest-out" "$HOME/digest-out")
STATE_DIRS=("./.state" "/tmp/digest-state" "$HOME/.digest-state")

# Станет:
TEMP_DIR="${HOME}/.digest-temp/${ARCHIVE_NAME}"
ARCHIVE_PATH="${HOME}/.digest-temp/${ARCHIVE_NAME}.tar.gz"
OUTPUT_DIRS=("./out" "${HOME}/.digest-out" "${HOME}/digest-out")
STATE_DIRS=("./.state" "${HOME}/.digest-state" "${HOME}/.state")
```

**Добавить проверку CA сертификата:**

```bash
# Проверить несколько возможных путей к CA
CA_PATHS=(
    "/etc/ssl/corp-ca.pem"
    "${HOME}/.ssl/corp-ca.pem"
    "./certs/corp-ca.pem"
)
```

### 2. `test_run.sh`

**Изменить:**

```bash
# Было:
OUT_DIR="${OUT_DIR:-/tmp/digest-out}"
STATE_DIR="${STATE_DIR:-/tmp/digest-state}"

# Станет:
OUT_DIR="${OUT_DIR:-${HOME}/.digest-out}"
STATE_DIR="${STATE_DIR:-${HOME}/.digest-state}"
```

### 3. `print_env.sh`

**Изменить проверку CA:**

```bash
# Было:
if [ -f "/etc/ssl/corp-ca.pem" ]; then
    echo "✓ Corporate CA found: /etc/ssl/corp-ca.pem"
else
    echo "✗ Corporate CA not found: /etc/ssl/corp-ca.pem"
fi

# Станет:
echo "CA certificate:"
CA_FOUND=false
for ca_path in "/etc/ssl/corp-ca.pem" "${HOME}/.ssl/corp-ca.pem" "./certs/corp-ca.pem"; do
    if [ -f "$ca_path" ]; then
        echo "✓ Corporate CA found: $ca_path"
        CA_FOUND=true
        break
    fi
done
if [ "$CA_FOUND" = false ]; then
    echo "✗ Corporate CA not found in standard locations"
fi
```

**Изменить проверку директорий:**

```bash
# Было:
for dir in /opt/digest/out /opt/digest/.state; do

# Станет:
for dir in "${HOME}/.digest-out" "${HOME}/.digest-state" "./out" "./.state"; do
```

### 4. `run-local.sh`

**Изменить:**

```bash
# Было:
OUT_DIR="${OUT_DIR:-/tmp/digest-out}"
STATE_DIR="${STATE_DIR:-/tmp/digest-state}"

# Станет:
OUT_DIR="${OUT_DIR:-${HOME}/.digest-out}"
STATE_DIR="${STATE_DIR:-${HOME}/.digest-state}"
```

### 5. Документация

Обновить документацию для отражения новых путей:

- `MANUAL_TESTING_CHECKLIST.md` - обновить примеры путей
- `SEND_RESULTS.md` - обновить пути к архивам
- `TROUBLESHOOTING.md` - добавить раздел о правах доступа

## Преимущества изменений

1. **Безопасность**: Не требуются права на системные директории
2. **Портативность**: Работает на любой системе с доступом к домашней директории
3. **Изоляция**: Все файлы пользователя в одном месте
4. **Переопределение**: Можно задать свои пути через переменные окружения
5. **Совместимость**: Старые пути все еще работают через переменные окружения

## Новая структура директорий

```
$HOME/
├── .digest-logs/              # Логи приложения
│   └── run-YYYYMMDD-HHMMSS.log
├── .digest-out/               # Выходные файлы (по умолчанию)
│   ├── digest-YYYY-MM-DD.json
│   └── digest-YYYY-MM-DD.md
├── .digest-state/             # Состояние синхронизации
│   └── ews.syncstate
└── .digest-temp/              # Временные файлы и архивы
    └── diagnostics-YYYY-MM-DD-HH-MM-SS/
```

## Обратная совместимость

Все изменения обратно совместимы через переменные окружения:

```bash
# Если нужно использовать старые пути
export OUT_DIR=/tmp/digest-out
export STATE_DIR=/tmp/digest-state
./scripts/test_run.sh
```

## Тестирование изменений

После внесения изменений протестировать:

1. Запуск без прав root
2. Работа в ограниченной корпоративной среде
3. Переопределение путей через переменные окружения
4. Создание архивов диагностики
5. Доступ к логам и выходным файлам

### To-dos

- [ ] Создать скрипт digest-core/scripts/collect_diagnostics.sh для автоматического сбора логов, метрик и конфигурации в архив
- [ ] Обновить digest-core/src/digest_core/observability/logs.py для записи логов в файл с DEBUG уровнем
- [ ] Создать скрипт digest-core/scripts/test_run.sh - обертку для тестового запуска с автоматическим сбором диагностики
- [ ] Создать digest-core/docs/testing/MANUAL_TESTING_CHECKLIST.md с пошаговым чек-листом тестирования
- [ ] Создать digest-core/docs/testing/SEND_RESULTS.md с инструкциями по отправке результатов через корпоративную почту
- [ ] Добавить команду diagnose и опции --collect-logs, --log-file в digest-core/src/digest_core/cli.py
- [ ] Обновить README.md с инструкциями по тестированию и ссылками на новые документы