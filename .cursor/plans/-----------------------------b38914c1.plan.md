<!-- b38914c1-b07d-47f7-83e2-c0cd1e74e61a 70b0a05e-d028-42ac-beb2-405ce001aa69 -->
# План тестирования SummaryLLM на корпоративном ноутбуке

## Обзор

Вы будете запускать приложение на корпоративном ноутбуке с доступом к Exchange и LLM. Для эффективной диагностики создадим:

1. Скрипт автоматического сбора логов и диагностики
2. Пошаговый план тестирования с чек-листом
3. Инструкции по отправке результатов через корпоративную почту

## 1. Скрипт сбора диагностики

Создадим `digest-core/scripts/collect_diagnostics.sh` - универсальный скрипт, который:

- Собирает все логи в один архив
- Включает метрики Prometheus
- Добавляет информацию о конфигурации (без секретов)
- Создает отчет о системе
- Сохраняет вывод всех команд
- Формирует архив для отправки по почте

Формат: `diagnostics-YYYY-MM-DD-HH-MM-SS.tar.gz`

## 2. Обновление логирования

Модифицируем `digest-core/src/digest_core/observability/logs.py`:

- Добавим автоматическую запись в файл (не только stdout)
- Логи будут писаться в `~/.digest-logs/run-TIMESTAMP.log`
- Уровень DEBUG по умолчанию для диагностики
- Структурированный JSON формат для удобного анализа

## 3. Скрипт тестового запуска

Создадим `digest-core/scripts/test_run.sh` - обертка для тестирования:

- Автоматически создает директории для логов
- Запускает приложение с полным логированием
- Собирает метрики
- В конце автоматически вызывает collect_diagnostics.sh
- Выводит путь к архиву для отправки

## 4. Чек-лист тестирования

Создадим `digest-core/docs/testing/MANUAL_TESTING_CHECKLIST.md`:

### Этап 1: Подготовка окружения

- [ ] Установка зависимостей
- [ ] Проверка доступа к Exchange
- [ ] Проверка доступа к LLM Gateway
- [ ] Настройка конфигурации

### Этап 2: Smoke тесты

- [ ] Dry-run без LLM
- [ ] Проверка EWS подключения
- [ ] Проверка нормализации писем

### Этап 3: Интеграционные тесты

- [ ] Полный запуск с реальными данными
- [ ] Проверка генерации дайджеста
- [ ] Проверка метрик

### Этап 4: Тесты граничных случаев

- [ ] Пустой день (нет писем)
- [ ] Большой объем писем (>100)
- [ ] Письма с кириллицей
- [ ] Письма с вложениями

## 5. Инструкция по отправке результатов

Создадим `digest-core/docs/testing/SEND_RESULTS.md`:

- Как запустить тестирование
- Где найти архив с диагностикой
- Как отправить через корпоративную почту
- Что писать в теме письма
- Какую информацию включать в тело письма

## 6. Обновление CLI

Добавим в `digest-core/src/digest_core/cli.py`:

- Команду `diagnose` для быстрой диагностики
- Опцию `--collect-logs` для автоматического сбора после запуска
- Опцию `--log-file` для явного указания файла логов

## Структура файлов

```
digest-core/
├── scripts/
│   ├── collect_diagnostics.sh    # Новый: сбор диагностики
│   ├── test_run.sh                # Новый: тестовый запуск
│   └── print_env.sh               # Существующий
├── docs/
│   └── testing/
│       ├── MANUAL_TESTING_CHECKLIST.md  # Новый
│       └── SEND_RESULTS.md              # Новый
└── src/digest_core/
    ├── cli.py                     # Обновить: добавить команды
    └── observability/
        └── logs.py                # Обновить: добавить файловое логирование
```

## Использование

### Для вас (на корпоративном ноутбуке):

```bash
# 1. Подготовка
cd digest-core
make setup

# 2. Настройка переменных окружения
export EWS_PASSWORD="your_password"
export EWS_USER_UPN="user@corp.com"
export LLM_TOKEN="your_token"

# 3. Запуск тестирования (автоматически соберет логи)
./scripts/test_run.sh

# 4. Результат: получите путь к архиву
# diagnostics-2024-01-15-10-30-45.tar.gz

# 5. Отправка через корпоративную почту
# Прикрепите архив к письму и отправьте
```

### Для меня (анализ результатов):

```bash
# 1. Получить архив по почте
# 2. Распаковать
tar -xzf diagnostics-2024-01-15-10-30-45.tar.gz

# 3. Изучить логи
cd diagnostics-2024-01-15-10-30-45/
cat summary.txt              # Краткая сводка
cat logs/run.log | jq .      # Структурированные логи
cat metrics/prometheus.txt   # Метрики
cat config/sanitized.yaml    # Конфигурация без секретов
```

## Преимущества подхода

1. **Автоматизация**: Один скрипт собирает всё необходимое
2. **Полнота**: Включает логи, метрики, конфигурацию, системную информацию
3. **Безопасность**: Автоматически удаляет секреты из конфигурации
4. **Удобство**: Один архив для отправки по почте
5. **Воспроизводимость**: Каждый запуск создает отдельный архив с timestamp

### To-dos

- [ ] Создать скрипт digest-core/scripts/collect_diagnostics.sh для автоматического сбора логов, метрик и конфигурации в архив
- [ ] Обновить digest-core/src/digest_core/observability/logs.py для записи логов в файл с DEBUG уровнем
- [ ] Создать скрипт digest-core/scripts/test_run.sh - обертку для тестового запуска с автоматическим сбором диагностики
- [ ] Создать digest-core/docs/testing/MANUAL_TESTING_CHECKLIST.md с пошаговым чек-листом тестирования
- [ ] Создать digest-core/docs/testing/SEND_RESULTS.md с инструкциями по отправке результатов через корпоративную почту
- [ ] Добавить команду diagnose и опции --collect-logs, --log-file в digest-core/src/digest_core/cli.py
- [ ] Обновить README.md с инструкциями по тестированию и ссылками на новые документы