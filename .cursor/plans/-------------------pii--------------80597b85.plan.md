<!-- 80597b85-ace1-4b2d-af29-f1ab6e1e3236 2bbc25b5-f748-4dad-820c-ba1b8c54d899 -->
# План очистки рудиментов PII маскирования

## Контекст

Маскирование PII теперь выполняется на стороне **LLM Gateway API**, а не локально в приложении. Однако в коде, промптах и документации остались многочисленные упоминания локального маскирования и меток `[[REDACT:...]]`.

## Найденные рудименты

### 1. Промпты (критично)

**`digest-core/prompts/summarize.v1.j2`** (строки 19, 27):

- Инструкция сохранять метки `[[REDACT:...]]`
- Поле `**Ответственные:** [список с [[REDACT:...]]]`

**`digest-core/prompts/extract_actions.v1.j2`** (строки 2, 12):

- Инструкция сохранять метки `[[REDACT:...]]`
- Поле `owners_masked` с примером `[[REDACT:...]]`

### 2. Код (средний приоритет)

**`digest-core/src/digest_core/run.py`** (строки 114-116, 281-283):

- Вызовы `normalizer.mask_pii()` - мертвый код, метод ничего не делает

**`digest-core/src/digest_core/normalize/html.py`** (строки 65-68):

- Метод `mask_pii()` - заглушка для совместимости

**`digest-core/src/digest_core/llm/schemas.py`** (строка 6):

- Поле `owners_masked` - может быть переименовано в `owners`

**`digest-core/src/digest_core/assemble/markdown.py`** (строки 84-85):

- Использование `item.owners_masked`

**`digest-core/src/digest_core/assemble/jsonout.py`** (строки 61, 109, 210-211):

- Сериализация/десериализация `owners_masked`

**`digest-core/src/digest_core/llm/gateway.py`** (строка 264):

- Парсинг `owners_masked` из ответа LLM

### 3. Тесты (низкий приоритет)

**`digest-core/tests/test_masking.py`** - весь файл устарел
**`digest-core/tests/test_pii_policy.py`** - тесты заглушек
**`digest-core/tests/test_normalize.py`** - тест `test_mask_pii_no_masking`
**`digest-core/tests/mock_llm_gateway.py`** - моки с `[[REDACT:...]]`
**`digest-core/tests/snapshots/`** - снапшоты с `[[REDACT:...]]`

### 4. Документация (информационный)

Множественные упоминания в:

- `docs/README.md`
- `docs/reference/BRD.md`
- `docs/development/TECHNICAL.md`
- `docs/development/IMPLEMENTATION_GUIDE.md`
- `docs/development/TESTING.md`
- `docs/operations/MONITORING.md`
- И другие...

## Вопросы для уточнения

1. **Поле `owners_masked`**: Переименовать в `owners` или оставить как есть?

- a) Переименовать в `owners` (потребует изменений в схемах, промптах, тестах)
- b) Оставить `owners_masked` для обратной совместимости

2. **Метод `mask_pii()`**: Удалить полностью или оставить заглушку?

- a) Удалить метод и все его вызовы
- b) Оставить заглушку с предупреждением об устаревании

3. **Промпты**: Как обрабатывать имена ответственных?

- a) Просто указывать имена без меток (LLM Gateway замаскирует)
- b) Указывать "список ответственных" без примеров формата
- c) Полностью убрать поле "Ответственные" из промптов

4. **Документация**: Обновлять упоминания PII?

- a) Обновить все упоминания, указав что маскирование на стороне Gateway
- b) Удалить детали маскирования, оставить только "Privacy-First Design"
- c) Оставить как есть (уже указано что маскирование на стороне Gateway)

## Рекомендуемый подход

### Фаза 1: Промпты (обязательно)

- Удалить инструкции о сохранении `[[REDACT:...]]`
- Упростить поле "Ответственные" до простого списка имен
- Обновить JSON схему в `extract_actions.v1.j2`

### Фаза 2: Код (желательно)

- Удалить вызовы `mask_pii()` из `run.py`
- Удалить метод `mask_pii()` или пометить как deprecated
- Решить судьбу поля `owners_masked`

### Фаза 3: Тесты (опционально)

- Удалить/обновить устаревшие тесты маскирования
- Обновить моки и снапшоты

### Фаза 4: Документация (опционально)

- Упростить описания PII handling
- Удалить примеры с `[[REDACT:...]]`

### To-dos

- [ ] Проанализировать промпты и определить необходимые изменения
- [ ] Проанализировать код и найти все вызовы mask_pii() и использования owners_masked
- [ ] Проанализировать тесты на предмет устаревших проверок маскирования
- [ ] Проанализировать документацию на предмет устаревших описаний маскирования
- [ ] Получить от пользователя ответы на вопросы о подходе к очистке