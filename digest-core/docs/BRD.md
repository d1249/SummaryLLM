# (Business Requirements & DoD)

## 1) Цель и ценность

- Ежедневный дайджест корпоративных коммуникаций (MVP: только email через EWS), чтобы сотрудник за 2–4 минуты понимал «где мое действие/срочно/важно».
    
- Результаты стабильны и проверяемы: JSON-артефакт (строгая схема) + краткий Markdown.
    

## 2) Источники и охват (MVP)

- Источник: **Exchange Web Services (EWS)** с NTLM/UPN (autodiscover — **выключен**).
    
- Охват: последние 24 часа (параметризуемо), русло — Inbox (+ вложенные, если задано).
    
- Идентификаторы: `msg_id`, `conversation_id`, `datetime_received`, `sender`, `subject`, `text_body`.
    

## 3) Политика приватности / PII

- Маскирование выполняется **до** LLM (на стороне **LLM Gateway** или нормализатора).
    
- `[[REDACT:...]]` — **не изменяем** и **не раскрываем**.
    
- Запрещено логировать payload’ы и секреты. Только структурные логи и метрики.
    

## 4) Выходные артефакты (MVP)

- `digest-YYYY-MM-DD.json` (строгая схема, см. TECH.md) — источник истины.
    
- `digest-YYYY-MM-DD.md` — ≤400 слов, «мои действия / срочно / важное», с ссылками на evidence.
    
- В каждом пункте: `evidence_id`, `source_ref` (тип=`email`, `msg_id`), `confidence`, `due?`.
    

## 5) Обязательные свойства решения

- **Идемпотентность**: (user_id, date) → детерминированный результат; окно перестроения T-48ч.
    
- Трассируемость: `trace_id`/`run_id` в логах и артефактах; версионирование промптов.
    
- **Проверяемость**: pydantic-валидация на схему; снапшоты примеров; юнит-тест контракта.
    
- **Надёжность**: ретраи LLM (1–2), таймауты, возврат «strict JSON only».
    
- **Наблюдаемость**: метрики Prometheus (см. TECH.md), JSON-логи (structlog).
    

## 6) Приёмочные критерии (DoD, MVP)

- A. Загружаем ≥ N писем за сутки по EWS, без autodiscover, с NTLM.
    
- B. На выходе **ровно один** JSON, валидный по схеме; Markdown ≤400 слов.
    
- C. В каждом айтеме есть `evidence_id` и `source_ref.msg_id`, нет утечки PII.
    
- D. Метрики: латентность LLM, токены in/out, время сборки, emails_total — публикуются на :9108.
    
- E. Перезапуск за ту же дату не меняет результат при неизменных входных данных.
    
- F. Логи — структурные; секреты/тела писем не пишутся.
    

## 7) Риски и ограничения

- Шум/шаблоны (реплаи-цепочки, подписи) — разруливаем нормализацией/эвиденс-сплитом.
    
- HTML → текст: аккуратная чистка (цитаты, футеры, трекинг-пиксели).
    
- Частично дублируемые письма — используем watermark/SyncState и де-дупликацию по `msg_id`.
    