## üì° –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ø–æ—á—Ç–µ (Exchange on-prem, EWS/NTLM)

### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –¥–æ—Å—Ç—É–ø–∞

- –ò—Å—Ç–æ—á–Ω–∏–∫: **Microsoft Exchange Server on-premises**, –≤–µ—Ä—Å–∏—è 2013+ (EWS API).
    
- Endpoint: `https://owa.<corp-domain>.ru/EWS/Exchange.asmx` (–ø–æ—Ä—Ç 443).
    
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è: **NTLM (Integrated Windows Authentication)** –∏–ª–∏ Basic (–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å).
    
    - –ó–∞–≥–æ–ª–æ–≤–∫–∏ –ø—Ä–∏ `curl -I` –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç: `WWW-Authenticate: Negotiate, NTLM`.
        
    - OAuth –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, `X-OAuth-Enabled: True`, –Ω–æ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ —Å–µ—Ä–≤–µ—Ä —Ç—Ä–µ–±—É–µ—Ç NTLM.
        
- –î–æ—Å—Ç—É–ø —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª—Å—è —á–µ—Ä–µ–∑ `curl` –∏ –±–∏–±–ª–∏–æ—Ç–µ–∫—É `exchangelib` ‚Äî –æ—Ç–≤–µ—Ç 200 –ø—Ä–∏ NTLM-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.
    
- –°–ª—É–∂–±—ã –∫–∞—Ç–∞–ª–æ–≥–∞ –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ `ldap://directoryservice:<3268>` ‚Äî –Ω–æ –ø–æ–∫–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è.
    

### 2. –§–æ—Ä–º–∞—Ç—ã —É—á—ë—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

- –†–∞–±–æ—Ç–∞—é—Ç –¥–≤–∞ —Ñ–æ—Ä–º–∞—Ç–∞:
    
    1. **UPN (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)** ‚Äî `login@corp-domain.ru`
        
    2. **Domain\Username** ‚Äî `MSK\login`
        
- `.local` –≤ –¥–æ–º–µ–Ω–µ **–Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è**.
    
- –î–ª—è NTLM-–∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–∞—Ä–æ–ª—å –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º NTLM-—Ö–µ–Ω–¥—à–µ–π–∫–µ (–≤–Ω—É—Ç—Ä–∏ —Å–µ—Ç–∏, TLS).
    
- –¢–µ—Å—Ç–æ–≤—ã–µ –ª–æ–≥–∏–Ω—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã: HTTP 200 –Ω–∞ `login@xxx.ru` –∏ `login`.
    

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è

```bash
curl --ntlm -u 'login@xxx.ru:password' \
     https://owa.xxx.ru/EWS/Exchange.asmx -v
```

–û—Ç–≤–µ—Ç HTTP 200 –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —É—Å–ø–µ—à–Ω—ã–π NTLM-handshake.

–î–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ NTLM:

```bash
curl -I https://owa.xxx.ru/EWS/Exchange.asmx
# –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å WWW-Authenticate: NTLM
```

### 4. –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞

- **Python:** [`exchangelib`](https://ecederstrand.github.io/exchangelib/), –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç NTLM.
    
    ```python
    from exchangelib import Credentials, Account, Configuration, DELEGATE, NTLM
    creds = Credentials(username="login@xxx.ru", password="****")
    config = Configuration(server="owa.xxx.ru", credentials=creds, auth_type=NTLM)
    account = Account(primary_smtp_address="login@xxx.ru",
                      credentials=creds, config=config,
                      autodiscover=False, access_type=DELEGATE)
    ```
    
- –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ, —á—Ç–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç `autodiscover=True` ‚Äî –ø—Ä—è–º–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ.
    
- –î–ª—è Docker-—Å—Ä–µ–¥—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ CA (`ca-certificates` –ø–∞–∫–µ—Ç –≤ –æ–±—Ä–∞–∑–µ).
    
- –¢—Ä–µ–±—É–µ—Ç—Å—è TLS-–¥–æ–≤–µ—Ä–∏–µ –∫ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º—É CA, **–±–µ–∑ `--insecure`**.
    

### 5. –í—ã–±–æ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö

- –ë–∞–∑–æ–≤–∞—è –≤—ã–±–æ—Ä–∫–∞: `account.inbox.filter(datetime_received__gte=start_date)`
    
- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: `order_by('-datetime_received')`
    
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞: `[:MAX_ITEMS]`.
    
- –°—Ö–µ–º–∞ –∏–∑–≤–ª–µ–∫–∞–µ–º—ã—Ö –ø–æ–ª–µ–π:
    
    - `datetime_received`, `sender.email_address`, `subject`, `text_body`, `conversation_id`.
        
    - –î–ª—è —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫–∏: `id`, `changekey`, `folder`, `is_read`.
        
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —á–∞—Å–æ–≤–æ–≥–æ –ø–æ—è—Å–∞ —è—â–∏–∫–∞ —á–µ—Ä–µ–∑ `account.default_timezone`.
    

### 6. –ö–æ–Ω—Ç—Ä–æ–ª—å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ—Å—Ç—å

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è EWS `SyncState` –∏–ª–∏ `(itemId, changeKey)` –¥–ª—è high-water mark.
    
- –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –≤—ã–±–æ—Ä–∫–∞ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 48 —á –¥–ª—è –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏.
    
- –î–µ–¥—É–ø –ø–æ `hash_sha1` –æ—Ç `(conversation_id + subject + datetime_received)`.
    

### 7. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø–æ–ª–∏—Ç–∏–∫–∞

- –î–æ—Å—Ç—É–ø –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π —Å–µ—Ç–∏, –±–µ–∑ –ø—Ä–æ–±—Ä–æ—Å–∞ –Ω–∞—Ä—É–∂—É.
    
- –°–µ–∫—Ä–µ—Ç—ã (–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å) –∑–∞–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ ENV (`N8N_EXCH_PASS` / —Å–µ–∫—Ä–µ—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ).
    
- –õ–æ–≥–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∞—Ç –∑–Ω–∞—á–µ–Ω–∏–π –ø–æ–ª–µ–π `EXCH_PASS`.
    
- –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –¥–æ–≤–µ—Ä–∏–µ –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º (—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω `ca-certificates` –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ).
    
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –∞—É–¥–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ Exchange.
    

### 8. –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ fallback

|–°—Ü–µ–Ω–∞—Ä–∏–π|–ü–æ–≤–µ–¥–µ–Ω–∏–µ|
|---|---|
|–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å / 401|–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –ø–æ–Ω—è—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ ¬´Auth failed¬ª, –≤–æ—Ä–∫—Ñ–ª–æ—É –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è.|
|–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è / timeout|–ø–æ–≤—Ç–æ—Ä —á–µ—Ä–µ–∑ backoff (–¥–æ 1 —Ä–∞–∑–∞), –º–∞—Ä–∫–∏—Ä–æ–≤–∫–∞ ¬´—á–∞—Å—Ç–∏—á–Ω—ã–π –æ—Ç—á—ë—Ç¬ª.|
|–û—à–∏–±–∫–∞ SSL|–ø—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ø–æ—á–∫–∏ CA, –æ–ø–æ–≤–µ—â–µ–Ω–∏–µ, –Ω–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è `--insecure`.|

---

**–†–µ–∑—é–º–µ:**  
–î–æ—Å—Ç—É–ø –∫ –ø–æ—á—Ç–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω –Ω–∞ NTLM-–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∫ `EWS/Exchange.asmx` —á–µ—Ä–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫—É `exchangelib`.  
–§–æ—Ä–º–∞—Ç –ª–æ–≥–∏–Ω–∞ ‚Äî `login@domain.ru` –∏–ª–∏ `DOMAIN\login`.  
TLS-–¥–æ–≤–µ—Ä–∏–µ –∫ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–æ–º—É CA –æ–±–µ—Å–ø–µ—á–µ–Ω–æ.  
–î–ª—è –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ —Å–±–æ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `SyncState`/`itemId`.  
–í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ –Ω–µ –ø–∏—à—É—Ç—Å—è –≤ –ª–æ–≥–∏.